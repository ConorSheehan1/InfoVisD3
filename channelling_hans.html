<!DOCTYPE html>
<html lang="en" class="tas-com">

<head>
    <meta charset="utf-8">
    <title>gapminder</title>
    <!--    using d3 api, will need internet connection -->
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>

</head>

<body>
<!--    <input type="button" onclick="incrementValue()" value="increase year">-->
    <script type="text/javascript">
        // globals
        var dataset;
        // Define margins
        var margin = {top: 10, right: 10, bottom: 25, left: 25};
        var height = 600;
        var width = 1200;
        
        var inner_height = height-margin.top-margin.bottom;
        var inner_width = width-margin.left-margin.right;
        
        var regions = {"Asia": "red", "Oceania": "red", "Europe": "yellow", "Africa":"blue", "North America": "green", "South America": "green", "Central America": "green"}
        var counter = -1;
        var xScale;
        var yScale;
        
        // Create SVG element
        d3.select("body")
            .append("svg")
            .style("background", "aliceblue")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");;

        // select svg for later use
        var svg = d3.select("svg");
        
        getAxis = function(){
            // Create an x-axis connected to the x scale
				var xAxis = d3.svg.axis()
							  .scale(xScale)
                            .ticks(10)
							  .orient("bottom");
	
				//Define Y axis
				var yAxis = d3.svg.axis()
                              .scale(yScale)
                            .ticks(10)
                              .orient("left");
							  
				// Call the x-axis
				svg.append("g")
					.attr("class", "axis")
                    .attr("transform", "translate(0," + inner_height + ")")
					.call(xAxis);
					
				// Call the y axis
				svg.append("g")
					.attr("class", "axis")
                .attr("transform", "translate (" + 50 + " 0)")
					.call(yAxis);

        }

        getVis = function (year_data) {
            //remove all old circles
            svg.selectAll("circle").remove();
            
            //create new circles
            svg.selectAll("circle")
            .data(year_data)
            .enter()
            .append("circle")
            .attr("cx", function (d) {return xScale(parseInt(d.GDP))})
            .attr("cy", function (d) {return yScale(parseInt(d.LifeExp))})
            
            // map to area not radius!, pi*r**2 sqrt(r)/pi
            .attr("r", function (d) {return (Math.sqrt(parseInt(d.Population))/Math.PI)/200})
            .style("fill", function(d){return regions[d.Region]})
            .style("stroke", "black");
            
        }
        
        //https://www.dashingd3js.com/svg-text-element
        showYear = function(year_value){
            //remove old text
            svg.selectAll("text").remove();
            
            //add new text
            svg.selectAll("text")
            .data(year_value)
            .enter()
            .append("text")
            .attr("x", 60)
            .attr("y", 50)
            .text(year_value)
            .attr("font-family", "sans-serif")
            .attr("font-size", "50px")
            .attr("fill", "grey");
        }
        
        //http://learnjsdata.com/group_data.html
        sort_data = function(data) {
            return d3.nest()
                  .key(function(d) { return d.Year})
                  .entries(data);
        }
        
        // load csv
        d3.csv("./Gapminder_All_Time.csv", function (data, error) {
            if (error) {
                console.log("error loading csv")
            } else {
                console.log("data loaded", data);
                // group data by year
                dataset=sort_data(data);   
                
                // create scales
                xScale = d3.scale.log()
	            				.domain([d3.min(data, function(d){return +d.GDP}), d3.max(data, function(d){return +d.GDP})])
								.range([margin.left, inner_width]);
                
                yScale = d3.scale.linear()
	            				.domain([d3.min(data, function(d){return +d.LifeExp}), d3.max(data, function(d){return +d.LifeExp})])
								.range([inner_height, 0]);
                                
                // create axes
                getAxis();
                
                // crete a button once data is loaded
                var b = document.createElement("button");
                b.innerHTML = "increment year";
                b.onclick = function(){
                    counter++;
                    showYear(dataset[counter].key)
                    getVis(dataset[counter].values);
                };
                
                // add a linebreak before the button
                linebreak = document.createElement("br");
                document.body.appendChild(linebreak);
                document.body.appendChild(b);
            }
            
        });

    </script>
</body>

</html>